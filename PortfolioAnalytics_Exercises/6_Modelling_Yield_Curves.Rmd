---
title: "6. Modelling Yield Curves"
author: "Alexis Sciau"
date: "24 avril 2020"
output:
  html_document:
    code_folding: hide
    df_print: kable
    theme: default
    toc: yes
    toc_float: yes
    toc_depth: 4 
  pdf_document:
    toc: yes
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```


```{r loading libraries, echo=TRUE, message=FALSE, warning=FALSE}
library(data.table)
library(lubridate)
library(ggplot2)
library(pracma)
library(fasttime)
library(xts)
library(YieldCurve)
theme_set(theme_minimal())
```

## 6.1 Why a dynamic Yield-Curve Model ?

This chapter starts by some general observations about yield curves complexity.

```{r YC_dynamic_illustrations}
yc_dt <- fread("../data/data_YC_US")
yc_dt[,index:=fastPOSIXct(index)]
yc_dt[,index:=as.Date(index)]

tenors <- c(1/12,2/12,3/12,6/12,1,2,3,5,7,10,20,30)

colnames(yc_dt)<-c("index",tenors)

yc_dt_fig_61 <- melt(yc_dt,id="index")
yc_dt_fig_61[,tenor:=as.numeric(as.character(variable))]

yc_dt_fig_61[,index_f:=as.factor(index)]
ggplot(yc_dt_fig_61,aes(x=tenor,y=value,color=index_f))+geom_line(show.legend = FALSE)

yc_xts <- as.xts(yc_dt)
plot(yc_xts["1997/2011"])

summary(yc_dt)
yc_dt_fig_63 <- yc_dt_fig_61[tenor %in% c(0.25,0.5,1,2,3,5,7,10,20,30),mean_yield:=mean(value,na.rm=TRUE),by=tenor]
ggplot(yc_dt_fig_63,aes(x=tenor,y=mean_yield))+geom_line()+scale_y_continuous(limits = c(0,8))

yc_dt_fig_64 <- yc_dt_fig_61[tenor %in% c(0.25,0.5,1,2,3,5,7,10,20,30),mean_var:=var(value,na.rm=TRUE),by=tenor]
ggplot(yc_dt_fig_64,aes(x=tenor,y=mean_var))+geom_line()

yc_dt_col_txt <- fread("../data/data_YC_US")
yc_dt_col_txt[,index:=fastPOSIXct(index)]
yc_dt_col_txt[,index:=as.Date(index)]
cor_mat <- as.data.table(cor(yc_dt_col_txt[is.na(BC_2MONTH)==FALSE,-c(1:3,13)]))

cor_mat_plot<- cor_mat[,tenor_y:=colnames(cor_mat)]
cor_mat_plot <- melt(cor_mat_plot,id="tenor_y")
cor_mat[,tenor_y:=NULL]

cor_mat_plot[,tenor_yy:=factor(tenor_y,levels = rev(colnames(cor_mat)))]

ggplot(cor_mat_plot,aes(x=variable,y=tenor_yy,color=value, size=value)) + geom_point()

ggplot(cor_mat_plot,aes(x=variable,y=tenor_yy)) + geom_tile(aes(fill = value),colour="white") + scale_fill_gradient(low = "white", high = "steelblue")
```

Also, it states that **discount factors must be decreasing to avoid negative-rates and thus arbitrage opportunities**: this is not obvious/true anymore!

### 6.1.3 Risk Premia

We will try to understand better risk premia by recreating figure 6.7. The process to achive this is the following :
* get the rate and subset the same as in the book
* get NS parameters
* construct spot rates --> Nous faisons ici l'hypothèse que les données sont déjà des spot rates et pas des yiels pour séconomiser le besoin de les transformer
* construct discount factors
* construct forward rates
* compute risk premia

```{r risk_premia}
rp<-to.monthly(na.omit(yc_xts["1997/2011"][,-c(1,2,12)]),indexAt = "lastof", OHLC=FALSE)
matu<-as.numeric(colnames(rp))

NSParameters <- Nelson.Siegel(rate = rp, maturity = matu)
tenor <- seq(0.25,20,0.25)
rp_dt <- as.data.table(NSrates(NSParameters,tenor))
colnames(rp_dt) <- c("index",tenor)
rp_dt <- melt(rp_dt,id="index")
rp_dt[,tenor:=as.numeric(as.character(variable))]
rp_dt[,spot:=value]
rp_dt[,df:=1/(1+spot/100)^tenor]
rp_dt[,df_1:=.SD[tenor==1,df],by=index]
rp_dt[,df_p_1:=shift(df,type="lead",n=4),by=index]
rp_dt[,forward := ((df_1/df_p_1)^(1/tenor)-1)*100]
rp_dt[,future_spot:=shift(spot,n=12,type="lead")]
rp_dt[index>as.Date("2011-01-01"),future_spot:=NA]
rp_dt[,risk_premia:=(forward-future_spot)*100]
rp_dt[,index_f:=as.factor(index)]
rp_dt[,mean_rp:=mean(risk_premia,na.rm=TRUE),by=tenor]
ggplot(rp_dt,aes(x=tenor)) + geom_line(aes(y=risk_premia,color=index_f),show.legend = FALSE) + geom_line(aes(y=mean_rp),color="black")
```

We end up with a figure completely different from the fig 6.7 in the book... The conclusion, though, in the same : **forward rates are above realized futures rates**.

## 6.3 Statistical digression

Let's apply the PCA on the US rates data.

```{r pca}
pca <- prcomp(rp)
summary(pca)

pca_dt <- as.data.table(pca$x)
pca_dt <- pca_dt[,c(1:3)]
pca_dt[,t:=index(rp)]
pca_dt_plot <- melt(pca_dt,id="t")
ggplot(pca_dt_plot,aes(x=t,y=value, color=variable)) + geom_line()
```

Although satisfactory, we will restrain from going further and invest some time on Mathematics theory.